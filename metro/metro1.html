<html>
  <head>
    <title>Metro</title>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <style type="text/css">
      .dashboard {
        background-color: gray;
        border: 2px outset black;
        margin: 50px 20px;
        float: left;
      }

      .indicator {
        background-color: black;
        border: 3px outset black;
        padding: 3px;
        float: left;
      }

      .warn {
        background-color: yellow;
        color: black;
      }

      .error {
        background-color: red;
        color: white;
      }

      .clear {
        clear: left;
      }

      .segment {
        background-color: yellow;
        border: 2px solid blue;
        float: left;
        margin: 8px 1px;
        padding: 4px 10px;
      }
      .station {
        margin: 3px;
        padding: 10px;
        background-color: yellow;
        border: 2px solid black;
        float: left;
        border-radius: 10px;
      }
      .train {
        background-color: red;
      }
    </style>
    <script type="text/javascript">
      function pause(millis) 
      {
        var date = new Date();
        var curDate = null;

        do { curDate = new Date(); } 
        while(curDate-date < millis)
      }

      function OneWayOneTrainLine(line_obj) {
        this.line     = line_obj;
        this.nodes    = this.line.children();
      }

      OneWayOneTrainLine.prototype = {
        set_train: function(train) {
          this.nodes.first().addClass('train');
          train.line = this
          this.train = train
        },

        current_position: function() {
          return this.line.find('.train')
        },

        move_forward: function() {
          this.current_position().removeClass('train').next('div').addClass('train');
        },

        move_back: function() {
          this.current_position().removeClass('train').prev('div').addClass('train');
        },

        red_semaphore: function() {
          return !((this.train.reverse) ? this.current_position().prev('div') : this.current_position().next('div')).length
        },

        segment: function() {
          return this.current_position().hasClass('segment')
        },

        station: function() {
          return this.current_position().hasClass('station')
        }
      }

      function Train() {
        this.run = false;
        this.reverse = false;
      }

      Train.prototype = {
        test: function() { // on all signal lamps
          this.change_direction();
          this.door_signal_on();
          this.stop_signal_on();
        },

        start: function() {
          this.change_direction();
          this.door_signal_off();
          this.stop_signal_off();
          this.run = true;
        },

        change_direction: function() {
          this.reverse = !this.reverse;
          (this.reverse) ? $('.dashboard').find('.reverse').addClass('warn') : $('.dashboard').find('.reverse').removeClass('warn');
        },

        door_signal_on: function() {
          $('.dashboard').find('.door').addClass('error');
        },

        door_signal_off: function() {
          $('.dashboard').find('.door').removeClass('error');
        },

        stop_signal_on: function() {
          $('.dashboard').find('.stop').addClass('error');
        },

        stop_signal_off: function() {
          $('.dashboard').find('.stop').removeClass('error');
        },

        update_status: function() {
          if (this.line.red_semaphore())
            this.change_direction();

          (this.reverse) ? this.line.move_back() : this.line.move_forward();

          if (this.line.segment()) {
            this.door_signal_off();
            this.stop_signal_off();
            return 100;
          } else {
            this.stop_signal_on();
            this.door_signal_on();
            return (400 + Math.floor(Math.random() * 1000));
          }
        },
      }



      $(document).ready(function() {
        window.line1  = new OneWayOneTrainLine($('.line:first'));
        window.train1 = new Train();
        line1.set_train(train1);

        train1.test();
        setTimeout('train_start()', 3000);
      });
      
      function train_start() {
        go_cycle();
      }

      function go_cycle() {
        var timeout = train1.update_status();
        setTimeout('go_cycle()', timeout);
      }
    </script>
  </head>
  <body>
    <h1>Simple one way one train line</h1> <div class='line'>
      <div class='segment'></div>
      <div class='station'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='station'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='station'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='station'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='segment'></div>
      <div class='station'></div>
      <div class='segment'></div>
    </div>

    <div class='clear'></div>

    <div class='dashboard'>
      <div class='reverse indicator'>Reverse</div>
      <div class='stop indicator'>Stop</div>
      <div class='door indicator'>Door</div>
    </div>
  </body>
</html>
